---
title: "RALLF Forage Quality"
subtitle: "preliminary report"
date: "2023 February"
author: "Jesse Puka-Beals"
output:
  pdf_document
editor_options: 
  chunk_output_type: console
---

# To do

Pull in lignin data

# Review of activities 

Experiment was seeded in spring 2021, reducing the number of cuttings that could be taken in 2021. 

There was a drought in 2022, reducing the number of cuttings that could be taken in 2022. 

For 2021, The first cutting was in July2021. The 35-day cutting treatment (sometimes called the 5-cut system), was harvested 3 times in 2021. The 45-day cutting treatment (sometimes called the 4-cut system), was harvested 2 times in 2021. 

For 2022, the first cutting was in May2022. The 35-day cutting treatment was harvested 4 times in 2022. The 45-day cutting treatment was harvested 3 times in 2022. 

# Review of experimental design

variety = 6 levels

intensity = 2 levels (35 or 45 day) OR (5 cut or 4 cut)

plot = contains the varietyXintensityXsiteXrep = 6X2X2X4 = 96 unique plots

cut = the sequential cutting of that plot. first cut is 1, second cut is 2

harvest_code = numerical designation within a year of a unique siteXintensityXcut

There are 6 varieties of alfalfa * 4 reps = 24 plots for a given cutting intensity at a given site.

2021 half were harvested 3X and half 2X = `r 96/2*3+96/2*2`

2022 half were harvested 4X and half 3X = `r 96/2*4+96/2*3`

so we expect 576 datapoints 

We have 506 data points


```{r, echo=F, include=F}
knitr::opts_chunk$set(
  echo = F,
  warning = F, 
  message = F,
  comment = NA
)

library(tidyverse)
library(tidyr)

rm(list = ls())

```

```{r, include=F}
source("rallf_keys.R")

source("rallf_nir_22Feb2023.R")

```


\newpage
# Data we have

```{r}

dat5 %>% 
  dplyr::select(code,year,plot,rfq.legume) %>% 
  left_join(key3) %>%
  # glimpse()
  full_join(key2) %>% 
  # glimpse()
  left_join(key1) -> dat2


dat2 %>% 
  group_by(
    year,site,intensity,cut, harvest_code
  ) %>% 
  tally() %>% 
  filter(year<2023) %>% 
  mutate(n = na_if(n,1),
         n = replace_na(n,0)) %>% 
  arrange(harvest_code) %>% 
  filter(harvest_code<15) %>% 
  mutate(newcode = paste(year,harvest_code,sep="_")) %>% 
  filter(newcode != "2021_11" &
           newcode != "2021_12" &
           newcode != "2021_13" &
           newcode != "2021_14") %>% 
  dplyr::select(-newcode) %>% 
  mutate(n_expected = 24,
         n_missing = n_expected-n) %>% 
  dplyr::select(-c(n_expected,harvest_code)) %>% 
  knitr::kable(
    caption = "NIRS data"
  )

dat2 %>% 
  group_by(
    year,site,intensity,cut, harvest_code
  ) %>% 
  tally() %>% 
  filter(year<2023) %>% 
  mutate(n = na_if(n,1),
         n = replace_na(n,0)) %>% 
  arrange(harvest_code) %>% 
  filter(harvest_code<15) %>% 
  mutate(newcode = paste(year,harvest_code,sep="_")) %>% 
  filter(newcode != "2021_11" &
           newcode != "2021_12" &
           newcode != "2021_13" &
           newcode != "2021_14") %>% 
  dplyr::select(-newcode) %>% 
  mutate(n_expected = 24,
         n_missing = n_expected-n) %>% 
  dplyr::select(-c(n_expected,harvest_code)) %>% 
  filter(n_missing!=0) %>%
  knitr::kable(
    caption = "Missing NIRS data"
  )

```


As seen in tables, we have missing 24+24+1+14+22 data points. 
The two sets of 24 data points are for the first cut at rosemount in 2022, which have not been scanned as of 15Feb2023. 
The remaining missing data were also not scanned and is expected were discarded due to mold. 

With the exception of a cutting not scanned yet and some samples molded, we have a fully accounted for dataset. 

\newpage
# Preliminary analysis of data

```{r}

dat5 %>% 
  # colnames()
  dplyr::select(code,year,plot,
                CP,ADF,NDF,NDFD,rfv,
                rfq.legume) %>% 
  left_join(key3) %>% 
  left_join(key2) %>% 
  left_join(key1) -> dat1



```

# Predicted forage quality parameters by NIRS

We are predicting alfalfa forage quality parameters using near infrared red scanning with a generalist equation designed for all hay. Some labs use an alfalfa equation and some labs have different alfalfa equations for conventional and reduced lignin alfalfa as there are sometimes discrepencies. All predictions should be validated with wet chemistry, though even if inaccurate can be useful in estimating relative differences between treatments. 

Soil contamination can also cause issues with forage quality predictions. 

Expected forage quality parameters for alfalfa are easy to obtain for CP ADF NDF and RFV, they are not easy to obtain for RFQ. In general, I found that RFQ can range from 50 to 250, with most data between 100 and 200 and an average of 150. 



```{r Dairyland predicted values}
c(
  "CP",
  "ADF",
  "NDF",
  "Lignin"
) -> prmtr

c(
  20,
  31,
  38,
  6
) -> mdn

c(
  14,
  20,
  35,
  4
) -> mn

c(
  26,
  43,
  52,
  8
) -> mx

tibble(
  prmtr,
  mdn,
  mn,
  mx
) %>% 
  mutate(
    source="dairyland labs",
    .before=prmtr
  ) %>% 
  mutate(range = paste(mn,mx,sep = "-")) %>% 
  rename(
    median = mdn,
    parameter = prmtr
  ) %>% 
  dplyr::select(-c(mn,mx,source)) %>% 
  rename_all(str_to_title) %>% 
  knitr::kable(
    caption = "Expected forage quality ranges from Dairyland Labs"
  )

```

```{r predicted ranges aggregated}

# https://docs.google.com/spreadsheets/d/1AqVcEwv3PlHVcR5Vv5UqUliUcqOZj6dNMvK-FAArONg/edit#gid=1646351822

read.csv(
  "alfalfa_forageQuality_expectedValues.csv"
) -> dat_qual


dat_qual %>% 
  rename(
    "Grade" = quality.category,
  ) %>% 
  rename_all(str_to_title) %>% 
  rename_with(
    str_to_upper,
    4:8
  ) %>% 
  knitr::kable(
    caption= "Expected forage quality ranges from UMN, SDSU, Univeristy of Georgia and Dairyland"
  )

```


```{r}

dat_qual %>% 
  dplyr::filter(stage=="all") %>% 
  dplyr::select(-c(maturity,stage,quality.category)) %>% 
  rename_all(toupper) %>% 
  mutate(type = "expected") -> d1


dat1 %>% 
  summarise(
    across(
      c(CP,ADF,NDF,rfv,rfq.legume),
      mean
    )
  ) %>% 
  rename(
    RFQ = rfq.legume,
    RFV = rfv
  ) %>% 
  mutate_all(
    ~round(.x,0)
  ) %>% 
  mutate(
    type = "observed"
  ) %>% 
  mutate_all(as.character) %>% 
  bind_rows(d1) %>% 
  relocate(type,.before=CP) -> d2 

# d2 %>% 
#   knitr::kable()

c(
  20,
  30,
  40,
  150,
  150
) -> expctd

as_tibble(cbind(nms = names(d2), t(d2))) %>% 
  rename(
    Observed = V2,
    `Expected Range` = V3,
    `Forage Quality Parameter` = nms
  ) %>% 
  slice(-1) %>% 
  bind_cols(expctd) %>% 
  rename(Expected = "...4") %>% 
  relocate(Expected,.after=Observed) %>% 
  knitr::kable(
    caption = "Observed vs. expected forage quality in RALLF"
  )

```



\newpage
# Tables

```{r FQ by rep}

dat1 %>% 
  group_by(rep) %>% 
  rename_with(
    .cols = c(1:3, 11:15),
    str_to_title
  ) %>% 
  rename(
    RFV = rfv,
    RFQ = rfq.legume
  ) %>% 
  summarise(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=mean)
  ) %>% 
  mutate(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=~round(.x,0))
  ) %>% 
  knitr::kable(
    caption = "Forage quality by rep"
  )

```

```{r FQ by site}
dat1 %>% 
  group_by(site) %>% 
  rename_with(
    .cols = c(1:3, 11:15),
    str_to_title
  ) %>% 
  rename(
    RFV = rfv,
    RFQ = rfq.legume
  ) %>% 
  summarise(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=mean)
  ) %>% 
  mutate(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=~round(.x,0))
  ) %>% 
  knitr::kable(
    caption = "Forage quality by site"
  )

```


```{r FQ by year}
dat1 %>% 
  group_by(year) %>% 
  rename_with(
    .cols = c(1:3, 11:15),
    str_to_title
  ) %>% 
  rename(
    RFV = rfv,
    RFQ = rfq.legume
  ) %>% 
  # colnames()
  summarise(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=mean)
  ) %>% 
  mutate(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=~round(.x,0))
  ) %>% 
  knitr::kable(
    caption = "Forage quality by year"
  )
```


```{r FQ by cut}
dat1 %>% 
  group_by(cut) %>% 
  rename_with(
    .cols = c(1:3, 11:15),
    str_to_title
  ) %>% 
  rename(
    RFV = rfv,
    RFQ = rfq.legume
  ) %>% 
  summarise(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=mean)
  ) %>% 
  mutate(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=~round(.x,0))
  ) %>% 
  knitr::kable(
    caption = "Forage quality by cutting"
  )
```

```{r FQ by cutting intensity}
dat1 %>% 
  group_by(intensity) %>% 
  rename_with(
    .cols = c(1:3, 11:15),
    str_to_title
  ) %>% 
  rename(
    RFV = rfv,
    RFQ = rfq.legume
  ) %>% 
  summarise(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=mean)
  ) %>% 
  mutate(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=~round(.x,0))
  ) %>% 
  knitr::kable(
    caption = "Forage quality by harvest schedule"
  )

```

```{r FQ by variety}

dat1 %>% 
  group_by(variety) %>% 
  rename_with(
    .cols = c(1:3, 11:15),
    str_to_title
  ) %>% 
  rename(
    RFV = rfv,
    RFQ = rfq.legume
  ) %>% 
  summarise(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=mean)
  ) %>% 
  mutate(
    across(c(CP,ADF,NDF,NDFD,RFV,RFQ),
           .fns=~round(.x,0))
  ) %>% 
  knitr::kable(
    caption = "Forage quality by variety"
  )

```





\newpage
# Histograms

```{r RFQ}

dat1 %>% 
  # colnames()
  ggplot(aes(rfq.legume)) +
  stat_bin() +
  labs(
    x="RFQ"
  )

```

We expect an RFQ of around 150, we observed an RFQ of `r round(mean(dat1$rfq.legume),0)`

```{r}
dat1 %>% 
  # colnames()
  ggplot(aes(rfv)) +
  stat_bin() +
  labs(
    x="RFV"
  )
```

We expect an RFV of around 150, we observed an RFV of `r round(mean(dat1$rfv),0)`


```{r}
dat1 %>% 
  ggplot(aes(CP)) +
  stat_bin() 
```

We expect a crude protein of around 20%, we observed a CP of `r round(mean(dat1$CP),0)`

```{r}
dat1 %>% 
  ggplot(aes(ADF)) +
  stat_bin()

```

We expect an ADF of around 30%, we observed an ADF of `r round(mean(dat1$ADF),0)`

```{r}
dat1 %>% 
  ggplot(aes(NDF)) +
  stat_bin()

```

We expect an NDF of around 40%, we observed an NDF of `r round(mean(dat1$NDF),0)`



